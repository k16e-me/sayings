---
import Icon from 'astro-icon'
import Fab from './Fab.astro'

const { title } = Astro.props
---
<aside
    class="fixed inset-y-0 right-0 z-50 flex items-center ml-auto !m-0 h-screen opacity-0 translate-x-full transition duration-300 ease-in-out"
    id="slideover">
    <div class="bg-white w-[344px] sm:w-[424px] rounded-xl lg:rounded-2xl h-full max-h-[calc(100vh-80px)] mr-3 sm:mr-5 lg:mr-9 overflow-hidden">
        <div class="flex flex-col flex-shrink-0 overflow-hidden w-full h-full">
            <div class="bg-slate-100 flex items-center justify-between pr-5 shadow h-16">
                <h2 class="font-display text-xl p-5 h-full flex items-center text-slate-950">
                    { title }
                </h2>
                <Fab id="close" small>
                    <Icon name="close" class="w-5"/>
                    <span class="sr-only">Close</span>
                </Fab>
            </div>
            <div
                class="flex-1 overflow-auto p-5 relative"
                data-slideover-children>
                <slot/>
            </div>
        </div>
    </div>
</aside>

<style is:global>
    [data-slideover-children] > * {
        @apply absolute inset-3;
    }
</style>

<script>
    import { arrayFrom } from '../js/snips'

    const
        slideoverToggles = arrayFrom('[data-toggle="slideover"]'),
        backdrop = document.querySelector('[data-backdrop]'),
        slideover = document.getElementById('slideover'),
        close = document.getElementById('close'),
        translateIn = ['translate-x-0', 'opacity-100'],
        translateOut = ['translate-x-full', 'opacity-0'],
        body = document.body,
        hidden = ['invisible'],
        links = arrayFrom('[data-link]'),
        slideoverContent = arrayFrom('[data-slideover]', slideover)

    hideSlideoverContent()

    slideoverToggles.forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            const clickedEl = e.target
            const attr = clickedEl.getAttribute('data-slideover')
            const slideoverContentToShow = slideoverContent.find(el => (el.dataset.slideover === attr))

            slideoverContentToShow.style.display = 'block'

            body.style.overflow = 'hidden'
            backdrop.classList.remove('opacity-0')
            backdrop.classList.add('opacity-50')
            backdrop.classList.remove(...hidden)
            slideover.classList.add(...translateIn)
            slideover.classList.remove(...translateOut)
        })
    })

    backdrop.addEventListener('click', () => removeSlideover())
    close.addEventListener('click', () => removeSlideover())
    links.map(link => link.addEventListener('click', () => removeSlideover()))

    function removeSlideover() {
        body.style.overflow = 'auto'
        backdrop.classList.add('opacity-0')
        backdrop.classList.remove('opacity-50')
        slideover.classList.remove(...translateIn)
        slideover.classList.add(...translateOut)
        hideSlideoverContent()
        setTimeout(() => {
            backdrop.classList.add(...hidden)
        }, 300)
    }

    function hideSlideoverContent() {
        slideoverContent.forEach(el => el.style.display = 'none')
    }
</script>