---
import { useStoryblokApi } from '@storyblok/astro'
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro'
import Layout from '../../layouts/Layout.astro'
import BookCover from '../../components/BookCover.astro'
import BackTo from '../../components/BackTo.astro'
import TitlePiece from '../../components/TitlePiece.astro'
import FabToCard from '../../components/FabToCard.astro'
import Icon from 'astro-icon'
import Toast from '../../components/Toast.astro'
import ToggleOverview from '../../components/ToggleOverview.astro'
import Chapters from '../../components/Chapters.astro'
import Slideover from '../../components/Slideover.astro'
import Overview from '../../components/Overview.astro'
import Silence from '../../components/Silence.astro'
import Search from '../../components/Search.astro'

export async function getStaticPaths() {
	const sbApi = useStoryblokApi()
	const { data } = await sbApi.get('cdn/stories/', {
		starts_with: 'c/',
		version: import.meta.env.DEV ? 'draft' : 'published',
	})

	const stories = Object.values(data.stories)

	return stories.map((s: any) => {
		return {
			params: { slug: s.slug },
		}
	})
}

const sbApi = useStoryblokApi()
const { slug } = Astro.params
const { data } = await sbApi.get(`cdn/stories/c/${slug}`, {
	version: import.meta.env.DEV ? 'draft' : 'published',
})

const page = data.story
const cover = page.content.cover[0]
const pageTitle = page.content.title
---
<Layout
    pageTitle={ pageTitle }
    pageDescription={ page.content.description }
    pageThumbnail={ page.content.image?.filename }>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-x-0 gap-y-9 lg:gap-9">
        <div class="col-span-1">
            <div class="lg:sticky lg:top-10 space-y-5 flex flex-col items-end lg:items-stretch">
                <BackTo text={ 'Collections' }/>
                <div class="relative">
                    <BookCover
                        bg={ cover.pastel }
                        title={ cover.title }
                        filename={ cover.illustration.filename }
                        subtitle={ cover.subtitle }
                        class:list={ '' }
                    />
                    <ToggleOverview class:list={ `absolute bottom-3 right-3` }/>
                </div>
                <div class="fixed left-3 bottom-12 md:bottom-9 lg:static flex flex-col gap-3 lg:gap-5 z-30">
                    <button
                        class="lg:w-full group"
                        data-toggle="slideover"
                        data-slideover="chapters">
                        <FabToCard>
                            <Icon name="list" class="w-6 pointer-events-none"/>
                            <span class="sr-only lg:not-sr-only lg:font-display pointer-events-none">Chapters</span>
                        </FabToCard>
                    </button>
                    <TitlePiece
                        linkFragment={ cover.title }
                        bg={ cover.pastel }
                    />
                </div>
            </div>
        </div>
        <div class="lg:col-span-2 r-piece flex flex-col">
            <Search/>
            <StoryblokComponent blok={ page.content }/>
            <Silence bg={ cover.pastel } class:list={ `h-[152px]` }/>
        </div>
    </div>
    <Slideover>
        <Chapters pieces={ page.content.pieces }/>
        <Overview content={ page.content.overview }/>
    </Slideover>
    <Toast/>
</Layout>